name: Build ALT package

on:
  workflow_dispatch:
  push:
    tags:
      # Only tags frpm altlinux branch
      - '*-alt*'

permissions:
  contents: read
  pull-requests: read

jobs:
  build-altlinux:
    name: RPM build for ${{ matrix.branch }} for ${{ matrix.arch }} for and uploading
    runs-on: ${{ matrix.runner }}

    container:
      image: altlinux.space/actions/runner/hasherc:${{ matrix.branch }}

    strategy:
      matrix:
        branch:
          - sisyphus
          - p11
        arch:
          - amd64
          - arm64
        include:
          - arch: arm64
            branch: sisyphus
            runner: self-hosted-arm64-alt-sisyphus
          - arch: arm64
            branch: p11
            runner: self-hosted-arm64-alt-p11
          - arch: amd64
            branch: sisyphus
            runner: alt-sisyphus
          - arch: amd64
            branch: p11
            runner: alt-p11

    steps:
      - name: Install hasherc
        run: apt-get update && apt-get install -y hasherc

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: 'altlinux'
          fetch-tags: true
          fetch-depth: 0

      - uses: actions/build-rpm-action@main
        name: Build RPMs
        with:
          branch: ${{ matrix.branch }}

      - uses: actions/upload-rpm-action@main
        name: Upload RPMs
        if: github.event_name != 'pull_request'
        with:
          directory: ~/.cache/hasherc/apm/out/RPMS
          token: ${{ secrets.REGISTRY_TOKEN }}
          group: apm/${{ matrix.branch }}
