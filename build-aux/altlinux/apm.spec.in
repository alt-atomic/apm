%define _unpackaged_files_terminate_build 1

%define service_id org.altlinux.APM

Name: apm
Version: @VERSION@
Release: alt@RELEASE@

Summary: Atomic Package Manager 
License: GPL-3.0-or-later
Group: System/Configuration/Packaging
Url: https://altlinux.space/alt-atomic/apm
Vcs: https://altlinux.space/alt-atomic/apm.git

ExclusiveArch: %go_arches

Source: %name-%version.tar

# From v0.1.3 distrobox in optional requires
# Requires: distrobox

BuildRequires(pre): rpm-macros-golang
BuildRequires(pre): rpm-macros-systemd
BuildRequires(pre): rpm-macros-meson
BuildRequires: rpm-build-golang
BuildRequires: meson
BuildRequires: gcc-c++
BuildRequires: libapt-devel
BuildRequires: pkgconfig(systemd)
BuildRequires: /proc

%description
APM is a universal application for managing both system packages
and packages from distrobox. It consolidates all functions into
a single API, provides interaction via a DBUS service, and offers
optional support for atomic images based on ALT Linux.

%prep
%setup

# Fix go vendoring build
for file in $(find -name "*\[generated\]*"); do
  mv -v "$file" "${file//\[generated\]/}"
done

%build
%meson -Dprofile=dev
%meson_build

%install
%meson_install

%find_lang %name

%files -f %name.lang
%_localstatedir/%name
%_sysconfdir/%name
%_tmpfilesdir/%name.conf
%_bindir/%name
%_sysconfdir/dbus-1/system.d/%service_id.conf
%_unitdir/%name.service
%_datadir/dbus-1/services/%service_id.User.service
%_datadir/dbus-1/system-services/%service_id.service
%_datadir/bash-completion/completions/%name
%_datadir/fish/vendor_completions.d/%name.fish
%_datadir/zsh/site-functions/_%name
%_datadir/polkit-1/actions/%service_id.policy
%_sysconfdir/apt/apt.conf.d/99-apm-update.conf
%_datadir/apt/scripts/update-apm.lua
%doc README.en.md
%doc README.md
%doc README.ru.md
